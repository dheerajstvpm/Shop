---
import Layout from "../../../layouts/Layout.astro";
import dbConnect from "../../../lib/db";
import Product from "../../../models/productModel";
import { actions } from "astro:actions";

const admin = Astro.locals.admin;
if (!admin) {
    return Astro.redirect("/admin/login");
}

await dbConnect();
const products = await Product.find({}).sort({ _id: -1 }).lean();

const result = Astro.getActionResult(actions.admin.deleteProduct);
// If succesful delete, we might want to refresh, Astro SSR does this automatically on re-render.
---

<Layout title="Shop.admin | Products" admin={true}>
    <div class="container minHeight">
        <div
            class="d-flex justify-content-between my-3 border-bottom align-items-center"
        >
            <h1>Product Management</h1>
            <div>
                <a href="/admin/products/add" class="btn btn-outline-dark me-2"
                    >Add Product</a
                >
                <a href="/admin" class="btn btn-dark">Back</a>
            </div>
        </div>

        {
            result?.error && (
                <div class="alert alert-danger">{result.error.message}</div>
            )
        }

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Image</th>
                        <th scope="col">Name</th>
                        <th scope="col">Category</th>
                        <th scope="col">Price</th>
                        <th scope="col">Stock</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {
                        products.map((product, index) => (
                            <tr>
                                <th scope="row">{index + 1}</th>
                                <td>
                                    <img
                                        src={`/images/image1${product._id}.jpg`}
                                        style="width: 50px; height: 50px; object-fit: contain;"
                                        alt="product"
                                    />
                                </td>
                                <td>{product.productName}</td>
                                <td>{product.category}</td>
                                <td>&#x20B9;{product.price}</td>
                                <td>{product.stock}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        {/* Edit Link - To be implemented */}
                                        <a
                                            href={`/admin/products/edit/${product._id}`}
                                            class="btn btn-sm btn-outline-secondary"
                                        >
                                            Edit
                                        </a>

                                        {/* Delete Form */}
                                        <form
                                            method="POST"
                                            action={actions.admin.deleteProduct}
                                            onsubmit="return confirm('Are you sure?');"
                                        >
                                            <input
                                                type="hidden"
                                                name="id"
                                                value={product._id.toString()}
                                            />
                                            <button
                                                type="submit"
                                                class="btn btn-sm btn-outline-danger"
                                            >
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        ))
                    }
                </tbody>
            </table>
        </div>
    </div>
</Layout>
